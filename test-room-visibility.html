<!DOCTYPE html>
<html>
<head>
    <title>Test Room Visibility</title>
    <script src="https://unpkg.com/colyseus.js@^0.15.0/dist/colyseus.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .room { border: 2px solid #4CAF50; margin: 10px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        .debug { background: #333; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .error { color: #ff6b6b; background: #4a1a1a; padding: 10px; border-radius: 4px; }
        .success { color: #4CAF50; }
        .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>üéÆ Room Visibility Test</h1>
    <div id="status">Starting...</div>
    <div id="debug" class="debug"></div>
    <div id="rooms"></div>
    
    <button class="button" onclick="createRoom()">Create New Room</button>
    <button class="button" onclick="refreshRooms()">Refresh Rooms</button>
    
    <script>
        let client = null;
        let lobby = null;
        const selectedGameId = 'the-battle';
        
        async function init() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.innerHTML = 'üîå Connecting to lobby...';
                
                client = new Colyseus.Client('ws://localhost:3002');
                lobby = await client.joinOrCreate('lobby');
                
                statusDiv.innerHTML = '<span class="success">‚úÖ Connected to lobby!</span>';
                
                // Set up event handlers
                lobby.onMessage('rooms_updated', handleRoomsUpdated);
                lobby.onMessage('room_created', handleRoomCreated);
                
                // Initial room refresh
                refreshRooms();
                
            } catch (error) {
                statusDiv.innerHTML = \`<div class="error">‚ùå Error: \${error.message}</div>\`;
                console.error('Error:', error);
            }
        }
        
        function handleRoomsUpdated(data) {
            console.log('üì° Rooms updated:', data);
            
            const debugDiv = document.getElementById('debug');
            const roomsDiv = document.getElementById('rooms');
            
            const allRooms = data.activeRooms || [];
            const filteredRooms = allRooms.filter(r => r.gameId === selectedGameId);
            
            debugDiv.innerHTML = \`
                <h3>üîç Debug Info:</h3>
                <p><strong>Selected Game ID:</strong> \${selectedGameId}</p>
                <p><strong>Total Rooms Received:</strong> \${allRooms.length}</p>
                <p><strong>Filtered Rooms (for \${selectedGameId}):</strong> \${filteredRooms.length}</p>
                <p><strong>Timestamp:</strong> \${new Date().toLocaleTimeString()}</p>
            \`;
            
            if (allRooms.length > 0) {
                let html = '<h2>üìã All Rooms:</h2>';
                allRooms.forEach(room => {
                    const isMatch = room.gameId === selectedGameId;
                    html += \`
                        <div style="border: 2px solid \${isMatch ? '#4CAF50' : '#ff6b6b'}; margin: 5px 0; padding: 10px; border-radius: 4px;">
                            <strong>Code:</strong> \${room.roomCode} \${isMatch ? '‚úÖ' : '‚ùå'}<br>
                            <strong>Name:</strong> "\${room.roomName}"<br>
                            <strong>Game ID:</strong> \${room.gameId}<br>
                            <strong>Players:</strong> \${room.playerCount}/\${room.maxPlayers}<br>
                            <strong>State:</strong> \${room.state}<br>
                            <strong>Private:</strong> \${room.isPrivate}
                        </div>
                    \`;
                });
                
                if (filteredRooms.length > 0) {
                    html += '<h2>üéØ Filtered Rooms (What Frontend Should Show):</h2>';
                    filteredRooms.forEach(room => {
                        html += \`
                            <div class="room">
                                <h3>üè† \${room.roomName}</h3>
                                <p><strong>Room Code:</strong> \${room.roomCode}</p>
                                <p><strong>Players:</strong> \${room.playerCount}/\${room.maxPlayers}</p>
                                <p><strong>State:</strong> \${room.state}</p>
                                <p><strong>Created:</strong> \${new Date(room.createdAt).toLocaleString()}</p>
                            </div>
                        \`;
                    });
                } else {
                    html += '<div class="error">‚ùå No rooms found for "the-battle" game</div>';
                }
                
                roomsDiv.innerHTML = html;
            } else {
                roomsDiv.innerHTML = '<div class="error">‚ùå No rooms found at all</div>';
            }
        }
        
        function handleRoomCreated(data) {
            console.log('üèóÔ∏è Room created:', data);
            document.getElementById('status').innerHTML = \`<span class="success">‚úÖ Room created: \${data.roomCode}</span>\`;
            // Refresh rooms to show the new room
            setTimeout(refreshRooms, 500);
        }
        
        function refreshRooms() {
            if (lobby) {
                console.log('üîÑ Refreshing rooms...');
                lobby.send('refresh_rooms');
            }
        }
        
        function createRoom() {
            if (lobby) {
                const roomName = prompt('Enter room name:', 'Test Room ' + Date.now());
                if (roomName) {
                    console.log('üöÄ Creating room:', roomName);
                    lobby.send('create_room', {
                        gameId: 'the-battle',
                        isPrivate: false,
                        roomName: roomName,
                        settings: {}
                    });
                }
            }
        }
        
        // Initialize when page loads
        init();
    </script>
</body>
</html>